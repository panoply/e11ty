var d=(i,o,t)=>new Promise((a,g)=>{var x=r=>{try{l(t.next(r))}catch(p){g(p)}},b=r=>{try{l(t.throw(r))}catch(p){g(p)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(x,b);l((t=t.apply(i,o)).next())});import T from"marked";import A from"gray-matter";import{slug as F}from"github-slugger";import{join as J,dirname as H}from"node:path";import{readFile as L,writeFile as M,access as N,mkdir as R}from"node:fs/promises";function $(i){return d(this,null,function*(){try{return yield N(i),!0}catch(o){return!1}})}function z(i,o){return d(this,null,function*(){try{let t=H(i);(yield $(t))||(yield R(t,{recursive:!0})),yield M(i,o)}catch(t){throw new Error(t)}})}function Q(i,o){let t=Object.assign({onContent:null,onHeading:null,onOutput:null,minify:!1,output:"",shortCode:"search",codeblock:[],ignore:Object.assign({},o==null?void 0:o.ignore),content:["blockquote","paragraph","list"],codeblocks:["bash"]},o);"heading"in t.ignore||(t.ignore.heading=[]),"syntax"in t.ignore||(t.ignore.syntax=[/^({{|{%|<[a-z]|:::)/g]);let a=[],g,x=t.onOutput!==null&&typeof t.onOutput=="function",b=t.content.includes("paragraph"),l=t.content.includes("blockquote"),r=t.content.includes("list"),p=s=>t.ignore.heading.some(e=>typeof e=="string"?e===s.toLowerCase():e.test(s)),m=s=>t.ignore.syntax.some(e=>e.test(s));i.addShortcode(t.shortCode,S),i.on("eleventy.after",()=>d(this,null,function*(){if(a.length>0){if(!g)throw new Error("[plugin-json-fusion] failed to obtain the output path");let s=JSON.stringify(a,null,t.minify?0:2);if(x){let e=t.onOutput(a);(Array.isArray(e)||typeof e=="object")&&(s=JSON.stringify(e,null,t.minify?0:2))}yield z(g,s),a=[],g=void 0}}));function S(s){return d(this,null,function*(){if(!g&&this.page.outputPath!==!1){let C=H(this.page.outputPath).replace(this.page.url.slice(0,-1),"");g=J(process.cwd(),C,t.output,s)+".json"}let e=new Map,q=yield L(this.page.inputPath),w=T.lexer(q.toString()),v=w[0].type==="hr"?w.splice(0,2).map(({raw:n})=>n).join(`
`):null;if(v===null)return;let h=A(v).data;if(h.fuse===!1)return;let u;w.forEach(n=>{if(n.type==="heading"){if(p(n.text)){u=void 0;return}u=n.text,e.has(n.text)||e.set(n.text,[])}else if(e.has(u)){if(n.type==="paragraph"&&b){if(m(n.text))return;e.get(u).push({text:n.text,type:"paragraph"})}else if(n.type==="blockquote"&&l){if(m(n.raw))return;e.get(u).push({text:n.raw.replace(/(^>|\n>)| \:.*(?=[^>])/g,""),type:"blockquote"})}else if(n.type==="code"&&t.codeblock.includes(n.lang))e.get(u).push({text:n.text,type:"codeblock",language:n.lang});else if(n.type==="list"&&r){if(m(n.raw))return;e.get(u).push({text:n.raw,type:"list"})}}});let c={page:h.title,description:h.description||"",tags:h.tags||[],url:this.page.url,content:[]};for(let n of e.keys()){let C=c.url.endsWith("/")?c.url.slice(0,-1):c.url,P=typeof t.onHeading=="function"?t.onHeading(n):null;if(P===!1)continue;let O={heading:typeof P=="string"?P:n,content:[],url:`${C}#${F(n)}`};e.get(n).forEach(({text:f,type:E,language:j=void 0})=>{if(typeof f=="string"&&f.length>0){let y=typeof t.onContent=="function"?t.onContent(f,E,j):null;if(y===!1)return;j?O.content.push({type:E,text:typeof y=="string"?y:f}):O.content.push({type:E,text:typeof y=="string"?y:f,language:j})}}),c.content.push(O)}return c.content.length>0&&a.push(c),""})}}export{Q as fusion};
